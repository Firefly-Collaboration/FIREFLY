<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configuration - FIREFLY</title>
  <link rel="stylesheet" href="css\style.css" /> 
  <script src="js\script.js" defer></script>

<!-- Highlight.js (CDN) -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Optional: add languages you want to pre-load (makes highlighting a bit faster/safer) -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>

<!-- Initialize after the lib loads -->
<script>
  // runs automatically when scripts defer-loaded and DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    if (window.hljs) hljs.highlightAll();
  });
</script>
</head>
<body>
  <!-- Topbar: black bar with logo, title, and menu icon -->
  <div class="topbar" id="topbar">
  <div class="logo-area">
    <a href="index.html" class="home-link">
      <img src="images/AIfly.png" alt="Logo" class="logo-img" />
      <span class="firefly-title">FIREFLY</span>
    </a>
  </div>
<!-- From Uiverse.io by vinodjangid07 --> 
  <button class="Btn-git" onclick="window.open('https://github.com/Firefly-Collaboration/FIREFLY', '_blank')">
    <svg class="svgIcon-git" viewBox="0 0 496 512" height="1.4em" xmlns="https://github.com/FireflySpectra/firefly_release"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
    <span class="text-git">Github</span>
  </button>
  <div class="menu-icon" id="menuIcon" tabindex="0" aria-label="Open menu">
    <span></span>
    <span></span>
    <span></span>
  </div>
    <div class="menu-drawer" id="menuDrawer">
      <ul>
        <li><a href=index.html#intro">About</a></li>
        <li><a href="demofitter.html">FIREFLY Demo</a></li>
        <li>
          <a href="index.html#install">Install →</a>
          <ul>
            <li><a href="installation.html">Installation</a></li>
            <li><a href="configuration.html">Configuration</a></li>
            <li><a href="start-fitting.html">Launch</a></li>
          </ul>
        </li>
        <li><a href="index.html#models">Models</a></li>
        <li>
          <a href="index.html#surveys">Surveys →</a>
          <ul>
            <li><a href="desi.html">DESI</a></li>
            <li><a href="sdss.html">SDSS</a></li>
          </ul>
        </li>
        <li><a href="index.html#gallery">Gallery</a></li>
        <li><a href="index.html#contact">Usage</a></li>
      </ul>
    </div>
  </div>

<div class="image-credit-wrapper">
<header class="hero-spectra"></header>
<div class="image-credit">Credit: Samuel Helps (FIREFLY Collaboration) — <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div>
</div>

  <header><h1>Configuration</h1></header>
  <main class="documentation-content config-section">
    <div id="star-background"></div>
    <section class="intro">
      <h2>Configuring FIREFLY for Spectral Fitting</h2>
      <p>
        Before launching into full spectral fitting with FIREFLY, it's essential to prepare your <a href="#input-data-requirements">input data</a> and define your <a href="#configuration-options">fitting configuration</a>.
        This guide walks you through the different settings FIREFLY has available, how to define your desired <a href="#configuration-options">model parameters</a>, and construct the appropriate <a href="#input-fits-structure">input FITS files</a> that FIREFLY requires. If you are interested in how to add your own/new models to FIREFLY, see <a href="#custom-models">Adding Your Own Stellar Population Models to FIREFLY</a>.
      </p>
    </section>

    <section class="options" id="configuration-options">
      <h3>Configuration Options</h3>
      <p>FIREFLY offers multiple degrees of freedom in modeling:</p>
      <ul>
        <li><b>Model Grids</b>: <code>MaStar</code> or <code>m11</code></li>
          <pre><code class="language-python"># choose model: 'm11','m11-sg','MaStar'
model_key = 'MaStar'</code></pre>
        <li><b>Model Libraries (flavour)</b>: e.g. <code>gold</code> for MaStar</li>
          <pre><code class="language-python"># m11: 'MILES', 'STELIB', 'ELODIE', 'MARCS'
# MaStar: 'gold'
model_lib = ['gold']</code></pre>        
        <li><b>Initial Mass Functions (IMF)</b>: Kroupa or Salpeter</li>
          <pre><code class="language-python"># choose IMF: 'kr' (Kroupa), 'ss' (Salpeter)
imfs = ['kr']</code></pre>
        <li><b>Dust Parameters</b>: max E(B-V), number of values, smoothing length</li>
          <pre><code class="language-python"># set parameters for dust determination: 'on', 'hpf_only' (i.e. E(B-V)=0)
hpf_mode = 'on' 

# Only change the following parameters, if you know what you are doing.
max_ebv = 1.5                   
num_dust_vals = 200             
dust_smoothing_length = 200 
max_iterations = 10
pdf_sampling = 300  </code></pre>
        <li><b>Dust Law</b>: Calzetti (recommended), Allen or Prevot</li>
          <pre><code class="language-python"># 'calzetti', 'allen', 'prevot'
dust_law = 'calzetti'</code></pre>
        <li><b>Milky Way Reddening</b>: Correct for Milky Way reddening</li>
          <pre><code class="language-python"># set whether to correct for Milky Way reddening
milky_way_reddening=True</code></pre>
        <li><b>Age and Metallicity Limits</b>: Use <code>AoU</code> for age of the universe or set manually</li>
          <pre><code class="language-python"># minimum age and metallicity of models to be used 
# choose age in Gyr or 'AoU' for the age of the Universe
age_limits = [0,'AoU']
Z_limits = [-3.,3.]</code></pre>
        <li><b>Emission Line Masking</b>: Customise masking options for fitting</li>
          <pre><code class="language-python"># set to value>0 for masking (20 recommended), otherwise 0
N_angstrom_masked=0 
# set emission lines to be masked, comment-out lines that should not be masked
emlines = [
		'He-II',    # 'He-II:  3202.15A, 4685.74'
		'Ne-V',     # 'Ne-V:   3345.81, 3425.81'
		'O-II',     # 'O-II:   3726.03, 3728.73'
		'Ne-III',   # 'Ne-III: 3868.69, 3967.40'
		'H-ζ',      # 'H-ζ:     3889.05'
		'H-ε',      # 'H-ε:     3970.07'
		'H-δ',      # 'H-δ:     4101.73'
		'H-γ',      # 'H-γ:     4340.46'
		'O-III',    # 'O-III:  4363.15, 4958.83, 5006.77'
		'Ar-IV',    # 'Ar-IV:  4711.30, 4740.10'
		'H-β',      # 'H-β:     4861.32'
		'N-I',      # 'H-I:    5197.90, 5200.39'
		'He-I',     # 'He-I:   5875.60'
		'O-I',      # 'O-I:    6300.20, 6363.67'
		'N-II',     # 'N-II:   6547.96, 6583.34'
		'H-α',      # 'H-α:     6562.80'
		'S-II',     # 'S-II:   6716.31, 6730.68'
		'Ar-III',   # 'Ar-III: 7135.67'
				]</code></pre>
        <li><b>Resolution</b>: Specify the instrument resolution of the survey. e.g. R=5000 for DESI</li>
          <pre><code class="language-python">r_instrument = np.zeros(len(wavelength))
r_instrument.fill(5000)</code></pre>
        <li><b>Wavelength Fitting Options</b>: Specify fitting options for wavelength calibration</li>
          <pre><code class="language-python"># specify data medium: 'air', 'vaccum'
data_wave_medium = 'vacuum'
# specify whether you would like to fit in air or vacuum wavelengths
fit_wave_medium='vacuum'</code></pre>
        <li><b>Flux Units</b>: Firefly assumes flux units of erg/s/A/cm^2</li>
          <pre><code class="language-python"># choose factor in case flux is scaled
# (e.g. flux_units=10**(-17) for MaNGA)
flux_units=10**(-17)</code></pre>
      </ul>
    </section>

    <section class="requirements" id="input-data-requirements">
      <h3>Input Data Requirements</h3>
      <ul>
        <li><b>Spectrum arrays</b>: <code>WAVE</code>, <code>FLUX</code>, <code>IVAR</code></li>
        <li><b>Redshift</b>: required for cosmological age estimation</li>
        <li><b>Metadata</b>: <code>ID</code>, <code>RA</code>, <code>DEC</code>, <code>SNR</code>, <code>VDISP</code></li>
          <pre><code class="language-python"># Get spectrum data
wavelength = hdul[1].data['WAVE'][i]
flux = hdul[1].data['FLUX'][i]
error = hdul[1].data['IVAR'][i]
redshift = hdul[1].data['REDSHIFT'][i]
ra = hdul[1].data['RA'][i]
dec = hdul[1].data['DEC'][i]
vdisp = hdul[1].data['VDISP'][i]
snr = hdul[1].data['SNR'][i]
id = hdul[1].data['ID'][i]</code></pre>      
      </ul>
    </section>

    <section class="fits-structure" id="input-fits-structure">
      <h3>Input FITS File Structure</h3>
      <p>Most FIREFLY launch pipelines expect a multi-spectrum FITS file with the following structure:</p>
      <ul>
        <li><b>Primary HDU</b>: contains global metadata (e.g. model key, redshift, SNR)</li>
        <li><b>Binary Table HDU</b>: per-spectrum data arrays (<code>FLUX</code>, <code>WAVE</code>, <code>IVAR</code>)</li>
      </ul>
      <p>Each spectrum must be self-contained with associated metadata embedded either in the header or the table structure.</p>
    </section>

    <section class="generation">
      <h3>Creating FITS Files for FIREFLY</h3>
      <p>The repository presents three different methods you can use to generate the input FITS files for FIREFLY (Note: these examples are for DESI):</p>

      <h4>Option 1: FIREFLY 'All-in-one' launch scripts on NERSC</h4>
      <p>The <code>firefly(AIO)_DESI_DR1.py</code> and <code>firefly(AIO)_DESI_EDR.py</code> scripts offer the quickest and most efficent way to fit DESI spectra. Because NERSC already hosts all DESI data releases, these scripts can read everything directly from the shared filesystem and fit the spectra straight away. If you have a NERSC account, this method handles all data retrieval internally, letting you skip the fits file creation needed in other approaches.</p>
      <p>On NERSC, launch these runs through SLURM using the provided <code>SBATCH_Fuji.sh</code> (DESI-EDR) and <code>SBATCH_Iron.sh</code> (DESI-DR1) batch scripts. The only part that usually needs editing in the sbatch files is the desired galaxy index range you want to fit and the correct path to the firefly(AIO) script:</p>
      <pre><code class="language-bash">START_INDEX=2600000
END_INDEX=2700000
SCRIPT_PATH="/global/cfs/cdirs/desi/users/helpss/FIREFLY/firefly/Launch/DESI/NERSC/run_scripts/SBATCH_Iron.sh" 
</code></pre>

<h4>Option 2: NERSC → FIREFLY File Builder (for SCIAMA or other HPCs)</h4>
  <p>If you want to run FIREFLY on another HPC system (e.g. SCIAMA) but still take advantage of NERSC's fast access to DESI spectra, the <code>NERSC_fits_create.py</code> script provides the ideal workflow. It retrieves all required DESI spectral data on NERSC, merges the B/R/Z arms, attaches the required metadata and FastSpecFit values, and outputs fully FIREFLY-ready FITS files that can be copied to any external machine for fitting.</p>
  <p>To choose which galaxies to export, edit the index range at the top of the script:</p>
  <pre><code class="language-python">START_SPECTRUM = 5000
END_SPECTRUM   = 10000</code></pre>
  <p>These indices correspond to rows in the DESI EDR <code>zall-pix-fuji.fits</code> catalog. (Note: this method was used to fit over a million galaxies on SCIAMA which utilised blocks of 5000 spectra per fits file for speed and memory optismisation on the HPC).</p>
  <p><b>Running the script on NERSC</b></p>
  <p>Once the desired galaxy index range is set, simply run the script via a terminal on NERSC:</p>
  <pre><code class="language-bash">python NERSC_fits_create.py</code></pre>
  <p>This will create an output file in your NERSC directory:</p>
  <pre><code class="language-bash">Data/DESI/DESI_EDR_data/DESI_EDR_5000-10000.fits</code></pre>
  <p>(<b>Important:</b> Ensure that all the file input and output paths are corrected for your placement the scirpt in your NERSC directory or within the cloned FIREFLY repoistory uploaded to NERSC. Remember that all file paths on NERSC require an extra <code>/</code> before <code>global</code>.)<p>
  <p><b>What this script does</b></p>
  <ul>
    <li>Reads the EDR <code>zall-pix-fuji.fits</code> and FastSpecFit catalogs</li>
    <li>Selects galaxies using optional filters (SPECTYPE, redshift, subsurvey, etc.)</li>
    <li>Retrieves each matching <code>coadd</code> file directly from the NERSC DESI data tree</li>
    <li>Merges B/R/Z wavelength, flux and ivar into single arrays</li>
    <li>Computes velocity dispersion (FastSpecFit or resolution-based)</li>
    <li>Computes a median SNR per spectrum</li>
    <li>Writes FIREFLY-compatible FITS files with columns:</li>
    <ul>
      <li><code>ID</code>, <code>WAVE</code>, <code>FLUX</code>, <code>IVAR</code></li>
      <li><code>REDSHIFT</code>, <code>RA</code>, <code>DEC</code></li>
      <li><code>VDISP</code>, <code>SNR</code>, <code>SURVEY_TYPE</code></li>
    </ul>
  </ul>

      <h4>Option 3: Manual Download FITS Builder (DESI)</h4>
      <p>If you do not have access to NERSC you can still manually download galaxy spectra from the public <a href="https://data.desi.lbl.gov/public/" target="_blank">DESI data directory</a> or run the <code>Local_fits_create.py</code> script on a normal machine to generate FIREFLY-compatible FITS files.</p>
      <ul>
        <li><b>Step 1</b>: Edit the top of <code>Local_fits_create.py</code> to set the range of galaxies you want to process</li>
        <pre><code class="language-python">START_SPECTRUM = 0      # Starting index in the DESI galaxy catalog
END_SPECTRUM = 5000     # Ending index (non-inclusive)</code></pre>
To process the next 5000 galaxies, simply update the index values on the next run:
        <pre><code class="language-python">START_SPECTRUM = 5000
END_SPECTRUM = 10000</code></pre>
        <li><b>Step 2</b>: Run the Script</li>
        <pre><code class="language-bash">python Local_fits_create.py</code></pre>
This will create an output file named like:
        <pre><code class="language-bash">Data/DESI/DESI_EDR_data/DESI_EDR_5000-10000.fits
</code></pre>
        <li><b>What This Script Does</b>
        <ul>
          <li>Downloads required DESI EDR catalogs (<code>zall-fuji.fits</code> and <code>fastspec-fuji.fits</code>) if not already cached</li>
          <li>Filters for galaxies and selects the index range you specify</li>
          <li>For each galaxy:</li>
          <ul>
            <li>Fetches the matching <code>coadd</code> spectrum from the public DESI archive</li>
            <li>Merges the B/R/Z data arms for concatenated arrays of <code>FLUX</code>, <code>WAVE</code> and <code>IVAR</code></li>
            <li>Computes velocity dispersion from FastSpec or spectral resolution</li>
            <li>Calculates median signal-to-noise (SNR), redshift, RA/Dec, and target type</li>
        </ul>
          <li>Writes all this data into a single multi-extension FITS file</li>
        </ul>
        </li>
      <p>(Note: Although all the online files should remain the same, the output paths and directory structure set in this script may need to be altered to the desired destination on your machine. This method downloads large numbers of spectra and therefore is heavily dependent on your internet connection speed and is may be slow.)</p>
      </section>

<section class="generation" id="custom-models">
  <h3>Adding Your Own Stellar Population Models to FIREFLY</h3>
   <p>This guide explains the format FIREFLY expects for stellar population models, where to place them inside the repository, and two simple ways to plug new models into <code>firefly_models.py</code>. All examples and requirements below are taken from the existing <code>firefly_models.py</code> script in the fitting engine as it is recommend that this is script you alter to implement compatible models with minimal editing.</p>
   <h4>Where to put your models</h4>
   <p>The models directory used by the code is defined at the top of <code>firefly_models.py</code>:</p>
   <pre><code class="language-python">MODELS_DIR = join(dirname(__file__), 'stellar_population_models')</code></pre>
   <p>So upload your model files under the repository path:</p>
   <pre><code class="language-bash">firefly/Fitting_Engine/stellar_population_models/</code></pre>
   <p>Follow the existing folder conventions:</p>
   <ul>
    <li><code>SSP_M11_<library>/</code> (e.g. <code>SSP_M11_MILES/</code>) - ASCII SSP files for the M11-type readers</li>
    <li><code>SSP_M11_<library>_SG/</code> - special .sg flavour read by the <code>m11-sg</code> branch</li>
    <li><code>MaStar_SSP_v1.1.fits.gz</code> —-single FITS file used by the <code>MaStar</code> branch</li>
    <li><code>EMILES_SSP/</code> - E-MILES FITS files</li>
  </ul>
  <h4>Format & structure FIREFLY expects (by model type)</h4>
  <ul>
    <li><b>M11 (ASCII SSP grids)</b>:
  <p>Reader uses <code>pandas.read_table(..., usecols=[0,2,3], names=['Age','wavelength_model','flux_model'], delim_whitespace=True)</code>. Requiring each SSP file to be a whitespace-delimited table with at least these columns in that order:</p>
  <ol>
    <li><b>Age</b> - the age label used to group rows (the code does <code>model_table.loc[model_table.Age == a, ['wavelength_model','flux_model']]</code>)</li>
    <li><b>wavelength</b> - wavelength column (Angstroms as used in the files)</li>
    <li><b>flux</b> - flux values corresponding to each wavelength point</li>
  </ol>
  <p>Files are discovered via the following convention:</p>
    <pre><code class="language-python">model_path = join(MODELS_DIR, 'SSP_M11_'+model_used, 'ssp_M11_' +model_used +'.' + imf_used)</code></pre>
    <p>The existing code then glob()s <code>model_path + '*'</code> and recognises metallicity by filename tokens. Allowed/recognized metallicity tokens in the code include (examples):</p>
    <pre><code class="language-bash">z001 z002 z004 z0001.bhb z0001.rhb z10m4 z-0.6 z-0.9 z-1.2 z-1.6 z-1.9</code></pre>
    <p>(For <code>m11-sg</code> the same tokens but filenames end with <code>.sg</code>, e.g. <code>z001.sg</code>.)</p>
    </li>
    <li><b>MaStar (single FITS grid)</b>:
    <p>The MaStar code expects a single FITS archive named <code>MaStar_SSP_v1.1.fits.gz</code> in the <code>stellar_population_models</code> folder. Internals used by the code include:</p>
    <ul>
      <li><code>hdul[1].data</code> - contains parameter arrays (ages <code>t</code>, metallicities <code>Z</code>, slopes <code>s</code>)</li>
      <li><code>hdul[2].data[0,:]</code> - the wavelength grid (<code>wavelength_int</code>)</li>
      <li><code>hdul[3].data</code> - the flux 4D/3D array (called <code>fluxgrid</code>), indexed by age/metal/slope</li>
    </ul>
    <p>The code selects IMF by slope (IMF codes: <code>'kr'</code> → slope 1.3, <code>'ss'</code> → slope 2.35) then reads the flux slice <code>fluxgrid[ii,jj,sidx,:]</code>.</p>
    </li>
    <li><b>E-MILES (FITS per SSP)</b>:
    <p>E-MILES reading code searches for files like <code>join(MODELS_DIR,'EMILES_SSP','Eku1.30')</code> and for each matched file it:</p>
    <ul>
      <li>Opens the file with <code>pyfits.open(i)</code> and takes <code>hdul[0].data</code> as the flux array</li>
      <li>Constructs the wavelength array as <code>np.arange(1680, 50000, 0.9)</code></li>
      <li>Derives age from the filename slice used in the existing code, so keep consistent file naming (the code extracts age from a substring of the file path: it assumes a fixed token layout).</li>
    </ul>
    </li>
    </ul>
    <h4>Important processing behaviour (so your models are compatible)</h4>
    <ul>
      <li><b>Wavelength medium:</b> the code converts between air/vacuum using <code>airtovac()</code> / <code>vactoair()</code>. Ensure you know whether your model wavelengths are air or vacuum and set <code>data_wave_medium</code> / <code>fit_wave_medium</code> appropriately when implementing new stellar population models into FIREFLY</code>.</li>
      <li><b>Downgrading:</b> if you want FIREFLY to match your model resolution to the instrument, the code calls <code>downgrade(wavelength,flux,deltal,self.specObs.vdisp, wave_instrument, r_instrument)</code> when <code>self.downgrade_models</code> is True. Provide the model spectral resolution as <code>deltal</code> (for MaStar the code reads an R array from the MaStar FITS), for M11/E-MILES the code sets a scalar <code>deltal</code>.</li>
      <li><b>Reddening:</b> FIREFLY will apply Milky Way E(B-V) correction with <code>unred()</code> if <code>ebv_mw</code> ≠ 0.</li>
      <li><b>Age and Z limits:</b> FIREFLY filters models by <code>self.age_limits</code> and <code>self.Z_limits</code> so ensure your SSP ages and metallicities fall in the ranges you intend to fit.</li>
    </ul>
    <h4>Two simple ways to make FIREFLY use your models</h4>
    <ul>
    <li><b>Option A - Minimal</b>: Place files in an existing model format & choose them at runtime
    <p>If you can package your models to match one of the existing readers above (ASCII M11-style, MaStar FITS grid or E-MILES FITS), then upload your files into <code>firefly/Fitting_Engine/stellar_population_models/</code> following the folder/name patterns used above. Example for M11-style:</p>
    <pre><code class="language-bash">firefly/Fitting_Engine/stellar_population_models/SSP_M11_MyLib/ssp_M11_MyLib.kr firefly/Fitting_Engine/stellar_population_models/SSP_M11_MyLib/ssp_M11_MyLib.ss # name metallicity files using the tokens used by the parser, e.g. z001 z002 ...</code></pre>
    <p>Then when you construct the model runner set <code>models</code> and <code>model_libs</code> appropriately:</p>
    <pre><code class="language-python">sp = StellarPopulationModel(specObs, outputFile, cosmo, models='m11', model_libs=['MyLib'], imfs=['kr'])</code></pre>
    <p>FIREFLY will follow the existing <code>m11</code> branch to locate files, read ages/wavelengths/fluxes and proceed without changing <code>firefly_models.py</code>.</p>
    </li>
    <li><b>Option B</b>: Add a new loader function in <code>firefly_models.py</code> (recommended for novel formats)
    <p>If your model format is different (e.g. a set of HDF5 files, a different FITS layout, or you want special metadata reading), add a dedicated branch in <code>get_model()</code> or, better, add a helper method and call it. Below is a minimal template you can paste into <code>firefly_models.py</code> (place it just below the other <code>elif self.models == '...'</code> branches).</p>
    <pre><code class="language-python"># --- Example: custom model loader (paste into firefly_models.py) ---
def load_custom_models(self, model_used, imf_used, deltal, vdisp,
                       wave_instrument, r_instrument, ebv_mw):
    """
    Purpose:
        Read your custom SSP/model files from:
            <FIREFLY>/Fitting_Engine/stellar_population_models/SSP_CUSTOM_<model_used>/
        and return exactly the 4 objects the rest of FIREFLY expects:
            wavelength, model_flux_list, age_list, metal_list

    Required return values:
        wavelength     -> 1D numpy array (model wavelength grid)
        model_flux     -> list (or array) of 1D numpy arrays, each an SSP spectrum
        age_list       -> list of ages (one per SSP)
        metal_list     -> list of metallicities (one per SSP)

    Notes / placeholders:
      - Replace / extend the file-reading branches below to match your file format
        (FITS, HDF5, ASCII, numpy .npy, etc).
      - `model_used` is intended to map to a subfolder name after 'SSP_CUSTOM_'.
      - Keep variable names and behaviour consistent with the rest of firefly_models.py:
          * use `self.data_wave_medium` to decide air/vacuum conversion (airtovac / vactoair)
          * use `self.downgrade_models` and the provided `downgrade()` helper if needed
          * apply MW attenuation via `unred(wavelength, ebv=0.0 - ebv_mw)` if ebv_mw != 0
    """
    model_dir = join(MODELS_DIR, 'SSP_CUSTOM_' + model_used)   # e.g. stellar_population_models/SSP_CUSTOM_MyLib
    files = sorted(glob.glob(join(model_dir, '*')))
    if len(files) == 0:
        raise FileNotFoundError(f"No files found in {model_dir}. Create the folder and add your model files.")

    model_flux = []
    age_model = []
    metal_model = []
    wavelength = None   # will be set from first file we successfully read

    for fpath in files:
        try:
            # ---------------------------
            # 1) Example: FITS-based file
            # ---------------------------
            if fpath.lower().endswith(('.fits', '.fits.gz', '.fz')):
                hdul = pyfits.open(fpath)
                # common possible field names:
                hdr = hdul[0].header
                # Attempt to read a wavelength array, adapting to your FITS structure:
                try:
                    # many SSP FITS store 1D flux in primary and wavelength implicit or in extension 1
                    flux = hdul[0].data.copy()
                    # attempt common wavelength carriers (customise to your files)
                    if 'WAVE' in hdul[1].data.names:
                        wave_int = hdul[1].data['WAVE']
                    elif 'wavelength' in hdul[1].data.names:
                        wave_int = hdul[1].data['wavelength']
                    else:
                        # fallback: if file does not have explicit wavelength, assume a uniform grid header entry:
                        if 'CRVAL1' in hdr and 'CDELT1' in hdr and flux is not None:
                            crval = hdr['CRVAL1']
                            cdelt = hdr['CDELT1']
                            wave_int = crval + cdelt * np.arange(len(flux))
                        else:
                            raise ValueError("Cannot locate wavelength in FITS file - adapt loader to your format.")
                except Exception:
                    # If extension structure differs, adapt here:
                    hdul.close()
                    raise

                # Example: metadata from header (customise to your headers)
                # If your files include AGE and Z in header use these; otherwise parse filename.
                age = hdr.get('AGE', None)                # e.g. AGE = 1.0 (Gyr) or in whatever units you choose
                metal = hdr.get('Z', None)               # e.g. Z = 0.02 (linear metallicity)
                hdul.close()

            # ---------------------------
            # 2) Example: ASCII / text table
            # ---------------------------
            elif fpath.lower().endswith(('.txt', '.dat', '.asc', '.ascii')):
                # Example: whitespace-delimited with columns: wavelength flux [optional: age, z]
                # Use pandas.read_table as in m11 branch if your ASCII matches that style.
                df = pd.read_table(fpath, delim_whitespace=True, header=None)
                # ASSUMPTION: first column = wavelength, second column = flux
                wave_int = df.iloc[:, 0].values
                flux = df.iloc[:, 1].values
                # Optionally: expect age/Z encoded in filename like mylib_age1.0_z0.02.dat
                age = None
                metal = None

            # ---------------------------
            # 3) Example: numpy / hdf5 / other - placeholder
            # ---------------------------
            else:
                # Placeholder: add your custom reader here.
                # For instance, for .npy: arr = np.load(fpath); wave_int = arr[:,0]; flux = arr[:,1]
                raise ValueError("Unknown file extension. Add a reader for this format in the loader.")

            # If age/metal were not in header, try to parse from filename using a convention.
            # Example filename convention: MyLib_age1.0_z0.02.fits  -> extract numbers
            if age is None or metal is None:
                # naive filename parsing - edit regexp to suit your naming
                fname = os.path.basename(fpath)
                # try to extract age token "age<val>" and z token "z<val>" or "Zp0.02" style
                import re
                age_match = re.search(r'age[_\-]?([0-9\.]+)', fname, flags=re.IGNORECASE)
                z_match = re.search(r'(?:z|Z|_z|_Z)([_\-]?[0-9\.]+)', fname)
                if age is None and age_match:
                    age = float(age_match.group(1))
                if metal is None and z_match:
                    try:
                        metal = float(z_match.group(1))
                    except Exception:
                        metal = None
                # final fallback defaults (replace with strict parsing if needed)
                if age is None:
                    age = 1.0    # Gyr or the unit you choose - ensure consistency with FIREFLY's age use
                if metal is None:
                    metal = 0.02

            # Convert wavelength medium if needed (use same helpers as file)
            if self.data_wave_medium == 'vacuum':
                wavelength_local = airtovac(wave_int)
            else:
                wavelength_local = wave_int

            # Store wavelength from first file read (assumes same grid for all SSPs; if not, you must resample)
            if wavelength is None:
                wavelength = wavelength_local.copy()
            else:
                # if grids differ you may need to resample flux to the master wavelength array here
                # placeholder: check equality and raise/warn if different
                if not np.allclose(wavelength, wavelength_local):
                    # NOTE: if your SSPs use different wavelength grids you must resample (interp1d)
                    raise ValueError("Model wavelength grids differ between files. Resample to a common grid before adding, or implement resampling here.")

            # optionally downgrade model resolution to match instrument
            if self.downgrade_models:
                mf = downgrade(wavelength, flux, deltal, self.specObs.vdisp, wave_instrument, r_instrument)
            else:
                mf = copy.copy(flux)

            # Apply Milky Way reddening correction if provided
            if ebv_mw != 0:
                attenuations = unred(wavelength, ebv=0.0 - ebv_mw)
                mf = mf * attenuations

            #  append outputs
            model_flux.append(mf)
            age_model.append(age)
            metal_model.append(metal)

        except Exception as e:
            print(f"[load_custom_models] Skipping file {fpath} due to error: {e}")
            continue

    # final sanity checks
    if wavelength is None or len(model_flux) == 0:
        raise RuntimeError("No valid models were loaded. Check file readers and file formats.")

    # Set the same attributes other loaders set so the rest of the pipeline works unchanged (with the exception of naming of results)
    self.model_wavelength = wavelength
    self.model_flux = model_flux
    self.age_model = age_model
    self.metal_model = metal_model

    # return values exactly as expected by get_model() callers
    return wavelength, model_flux, age_model, metal_model

# --- In get_model(), add a branch that calls your loader:
# elif self.models == 'MyCustom':
#     return self.load_custom_models(model_used, imf_used, deltal, vdisp,
#                                    wave_instrument, r_instrument, ebv_mw)
#
# Usage notes:
#  - Create a folder: stellar_population_models/SSP_CUSTOM_MyCustom/
#  - Put your files there, e.g. SSP_CUSTOM_MyCustom/ssp_age1.0_z0.02.fits
#  - Call FIREFLY with models='MyCustom' and model_libs=['<whatever you want to pass as model_used>']
#  - If your SSPs do not share the same wavelength grid, implement a safe resampling step before appending.</code></pre>
    <p>This method keeps the high-level flow in <code>get_model()</code> unchanged while isolating your file-format specifics inside <code>load_custom_models()</code>. Just remember FIREFLY's fitting pipelines expect the loader to return exactly:</p>
    <ul>
      <li><code>wavelength</code> - 1D wavelength array</li>
      <li><code>model_flux</code> - list/array of flux arrays (one per SSP)</li>
      <li><code>age</code> - list of ages for each SSP</li>
      <li><code>metal</code> - list of metallicities for each SSP</li>
    </ul>
    </li>
    </ul>
    <h4>Quick checklist before running</h4>
    <ol>
      <li>Your files are uploaded into <code>firefly/Fitting_Engine/stellar_population_models/</code></li>
      <li>If you used an existing reader format (m11 / MaStar / E-MILES) ensure filenames and tokens follow the parser's expectations (see tokens listed above)</li>
      <li>Decide whether to set <code>self.downgrade_models=True</code> (recommended if your models are higher resolution than the instrument) so FIREFLY will call <code>downgrade()</code></li>
      <li>Ensure <code>data_wave_medium</code> and <code>fit_wave_medium</code> are set correctly (air vs vacuum)</li>
      <li>If you added a new branch in <code>get_model()</code>, restart any running Python sessions so the modified module is reloaded</li>
    </ol>
  </section>
  </main>



  <script>
    const starContainer = document.getElementById('star-background');
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'star';

      const size = Math.random() * 2 + 1;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.opacity = Math.random();
      star.style.animationDuration = `${Math.random() * 4 + 1}s`;
      star.style.animationDelay = `${Math.random() * 5}s`;

      starContainer.appendChild(star);
    }
  </script>

<footer>
  <div style="max-width:1200px; margin:auto; padding: 20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:20px; font-size:0.95em;">
    <div>
      <h4 style="color:#f7ba2b; margin-bottom:8px;">Infomation</h4>
      <ul style="list-style:none; padding:0; margin:0;">
        <li><a href="index.html#intro" style="color:white; text-decoration:none;">About</a></li>
        <li><a href="index.html#models" style="color:white; text-decoration:none;">Models</a></li>
        <li><a href="index.html#contact" style="color:white; text-decoration:none;">Usage</a></li>
      </ul>
    </div>

    <div>
      <h4 style="color:#f7ba2b; margin-bottom:8px;">Get Started</h4>
      <ul style="list-style:none; padding:0; margin:0;">
        <li><a href="installation.html" style="color:white; text-decoration:none;">Installation</a></li>
        <li><a href="configuration.html" style="color:white; text-decoration:none;">Configuration</a></li>
        <li><a href="start-fitting.html" style="color:white; text-decoration:none;">Launch</a></li>
      </ul>
    </div>

    <div>
      <h4 style="color:#f7ba2b; margin-bottom:8px;">Projects</h4>
      <ul style="list-style:none; padding:0; margin:0;">
        <li><a href="publications.html" style="color:white; text-decoration:none;">Publications</a></li>
        <li><a href="desi.html" style="color:white; text-decoration:none;">DESI</a></li>
        <li><a href="sdss.html" style="color:white; text-decoration:none;">SDSS</a></li>
        
      </ul>
    </div>

    <div>
      <h4 style="color:#f7ba2b; margin-bottom:8px;">Data</h4>
      <ul style="list-style:none; padding:0; margin:0;">
        <li><a href="demofitter.html" style="color:white; text-decoration:none;">FIREFLY Demo</a></li>
        <li><a href="index.html#gallery" style="color:white; text-decoration:none;">Gallery</a></li>
        <li><a href="index.html#sky-map" style="color:white; text-decoration:none;">Sky Map</a></li>
      </ul>
    </div>
  </div>
  <div style="width:100%;margin:auto;">
    <canvas id="spectralWidget" style="width:100%;height:auto;"></canvas>
  </div>
  <p style="font-size: 0.85em; color: #868686;">
    &copy; 2026 Samuel Helps (FIREFLY Collaboration) | Code: 
    <a href="https://ui.adsabs.harvard.edu/abs/2017MNRAS.472.4297W" target="_blank">Wilkinson et al. (2017)</a>, 
    <a href="https://ui.adsabs.harvard.edu/abs/2022MNRAS.510.1538N" target="_blank">Neumann et al. (2022)</a> |
    Site & Infrastructure: Samuel Helps |
    <a href="credits.html">Credits</a>
  </p>
  <p style="font-size: 0.85em; color: #868686;">
    Code licensed under <a href="../LICENSE.md">MIT</a> | Content licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
  </p>
</footer>

<script>
const canvas = document.getElementById('spectralWidget');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = 150;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Generate synthetic data and model
const N = 600;
let spectrum = new Array(N);
let model = new Array(N);
let wavelength = new Array(N);
for (let i = 0; i < N; i++) {
    const x = i / N * 10;
    wavelength[i] = x;
    spectrum[i] = 15 + 6 * Math.sin(x * 0.6) + Math.random() * 2;
    model[i] = 15 + 6 * Math.sin(x * 0.6 + 0.1) + Math.random() * 1; // trailing model
}

let progress = 0;
const fadeLength = 80; // Number of points over which to fade out

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const margin = 0;
    const w = canvas.width - 2 * margin;
    const h = canvas.height - 2 * margin;

    const maxY = Math.max(...spectrum) + 5;
    const minY = Math.min(...spectrum) - 5;

    const toCanvas = (x, y) => [
        margin + (x / 10) * w,
        canvas.height - margin - ((y - minY) / (maxY - minY)) * h
    ];

    // Draw spectrum with fade
    ctx.lineWidth = 2;
    for (let i = Math.max(1, progress - fadeLength); i < progress && i < N; i++) {
        let alpha = (i - (progress - fadeLength)) / fadeLength; // 0..1 fade factor
        ctx.strokeStyle = `rgba(70,130,180,${alpha.toFixed(2)})`; // steelblue fade

        ctx.beginPath();
        const [x0, y0] = toCanvas(wavelength[i - 1], spectrum[i - 1]);
        const [x1, y1] = toCanvas(wavelength[i], spectrum[i]);
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.stroke();
    }

    // Draw model with fade
    for (let i = Math.max(1, progress - fadeLength - 20); i < progress - 20 && i < N; i++) {
        if(i < 1) continue;
        let alpha = (i - (progress - fadeLength - 20)) / fadeLength; // same fade factor shifted by delay
        if(alpha < 0) alpha = 0;
        if(alpha > 1) alpha = 1;

        ctx.strokeStyle = `rgba(218,165,32,${alpha.toFixed(2)})`; // goldenrod fade
        ctx.lineWidth = 2;

        ctx.beginPath();
        const [x0, y0] = toCanvas(wavelength[i - 1], model[i - 1]);
        const [x1, y1] = toCanvas(wavelength[i], model[i]);
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.stroke();
    }

    // Increment progress and loop
    if (progress < N + fadeLength + 20) {
        progress += 2;
        requestAnimationFrame(draw);
    } else {
        progress = 0; // Loop animation
        setTimeout(() => requestAnimationFrame(draw), 1000);
    }
}

draw();
</script>

</body>
</html>
